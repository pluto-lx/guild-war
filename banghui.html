<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå¸®ä¼šæ™ºèƒ½å¸®æˆ˜ç³»ç»Ÿ</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --ghost: #FF0000;     --cloud: #1E90FF;    
            --incense: #FFD700;   --joy: #9370DB;     
            --healer: #32CD32;    --admin-red: #FF4444;
            --bg-color: #f0f2f5;  --table-border: #ddd;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #4A90E2, #2E5984);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
        }

        .admin-controls {
            position: absolute;
            right: 20px;
            top: 20px;
            display: flex;
            gap: 10px;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            background: #e0e0e0;
            transition: all 0.3s;
        }

        .tab.active {
            background: #4CAF50;
            color: white;
        }

        .form-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover { background: #45a049; }
        .admin-btn { background: var(--admin-red) !important; }
        .admin-btn:hover { background: #cc0000 !important; }

        .players-list {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .player-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-btn {
            color: var(--admin-red);
            cursor: pointer;
            display: none;
        }

        .team-table {
            margin: 20px 0;
            border-collapse: collapse;
            width: 100%;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .team-table th {
            background: #4A90E2;
            color: white;
            padding: 12px;
            min-width: 240px;
        }

        .team-table td {
            border: 1px solid var(--table-border);
            padding: 10px;
            height: 60px;
            vertical-align: top;
        }

        .team-header {
            font-weight: bold;
            color: var(--admin-red);
            margin-bottom: 5px;
        }

        .team-member {
            margin: 3px 0;
            padding: 5px;
            border-radius: 3px;
            background: #f8f9fa;
        }

        .healer-mark {
            color: var(--healer);
            font-weight: bold;
        }

        .admin-mode .remove-btn { display: inline-block; }
        .admin-tools { display: none; }
        .admin-mode .admin-tools { display: flex; gap: 10px; }
        .generate-btn { display: none; }
        .admin-mode .generate-btn { display: inline-block; }

        @media print {
            body { background: white; }
            .admin-controls, .tab-container, .form-section > :not(#groupsContainer) {
                display: none !important;
            }
            #groupsContainer {
                width: 100% !important;
                margin: 0;
                padding: 0;
            }
        }

        .export-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            display: none;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="admin-controls">
            <input type="password" id="adminPwd" placeholder="ç®¡ç†å¯†ç " style="width:120px;">
            <button onclick="toggleAdmin()" id="adminLogin">ç®¡ç†ç™»å½•</button>
            <button onclick="toggleAdmin()" class="admin-btn" style="display:none;">é€€å‡ºç®¡ç†</button>
        </div>
        <h1 id="battleDate">å¸®æˆ˜æŠ¥åç³»ç»Ÿ</h1>
        <div class="tab-container">
            <div class="tab active" onclick="switchGuild('ciqui')">è¾å½’</div>
            <div class="tab" onclick="switchGuild('cimeng')">è¾æ¢¦</div>
        </div>
    </div>

    <div class="form-section">
        <div class="input-group">
            <div>
                <label>ç©å®¶å§“åï¼š</label>
                <input type="text" id="playerName" placeholder="è¾“å…¥æ¸¸æˆID">
            </div>
            <div>
                <label>é€‰æ‹©èŒä¸šï¼š</label>
                <select id="playerClass">
                    <option value="çµæ±">çµæ±ï¼ˆæ²»ç–—ï¼‰</option>
                    <option value="ç…é¬¼ç‹">ç…é¬¼ç‹</option>
                    <option value="ç½¡é¬¼ç‹">ç½¡é¬¼ç‹</option>
                    <option value="é›·é’äº‘">é›·é’äº‘</option>
                    <option value="å‰‘é’äº‘">å‰‘é’äº‘</option>
                    <option value="åˆæ¬¢">åˆæ¬¢</option>
                    <option value="ç‚ç„šé¦™">ç‚ç„šé¦™</option>
                    <option value="å’’ç„šé¦™">å’’ç„šé¦™</option>
                </select>
            </div>
            <button onclick="addPlayer()">æ·»åŠ ç©å®¶</button>
        </div>

        <div class="admin-tools">
            <button class="admin-btn" onclick="clearData()">æ¸…ç©ºæ•°æ®</button>
            <button onclick="exportData()">å¯¼å‡ºå›¾ç‰‡</button>
            <button class="generate-btn" onclick="autoGroup()">ç”Ÿæˆç¼–é˜Ÿ</button>
        </div>

        <div class="players-list">
            <h3>å·²æŠ¥åï¼ˆ<span id="playerCount">0</span>/100ï¼‰å¾…å‘½ï¼š<span id="reserveCount">0</span></h3>
            <div id="registeredPlayers"></div>
        </div>
        
        <div id="groupsContainer"></div>
    </div>

    <div class="export-loading" id="exportLoading">æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...</div>

    <script>
        const CONFIG = {
            password: 'admin2024',
            maxMain: 100,
            maxReserve: 50,
            groupSize: 5,
            maxGroups: 5,
            minHealersPerTeam: 1
        };

        let currentGuild = 'ciqui';
        let guildData = JSON.parse(localStorage.getItem('guildData')) || {
            ciqui: { main: [], reserve: [] },
            cimeng: { main: [], reserve: [] }
        };

        // æ ¸å¿ƒåŠŸèƒ½
        function getNextFriday() {
            const date = new Date();
            date.setDate(date.getDate() + ((5 - date.getDay() + 7) % 7));
            return `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥`;
        }

        function addPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const className = document.getElementById('playerClass').value;
            
            if (!name) return alert("è¯·è¾“å…¥ç©å®¶å§“å");
            
            const data = guildData[currentGuild];
            const player = {
                name,
                className,
                role: className === 'çµæ±' ? 'æ²»ç–—' : 'è¾“å‡º',
                timestamp: Date.now()
            };

            if (data.main.length < CONFIG.maxMain) {
                data.main.push(player);
            } else if (data.reserve.length < CONFIG.maxReserve) {
                data.reserve.push(player);
            } else {
                alert("æŠ¥åäººæ•°å·²æ»¡ï¼");
            }
            
            updateUI();
            document.getElementById('playerName').value = '';
        }

        function autoGroup() {
            const data = guildData[currentGuild];
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '';

            const healers = data.main.filter(p => p.role === 'æ²»ç–—');
            const dps = data.main.filter(p => p.role !== 'æ²»ç–—');
            const totalPlayers = healers.length + dps.length;

            // æ™ºèƒ½åˆ†é…é€»è¾‘
            let teams = [];
            
            // ç¬¬ä¸€é˜¶æ®µï¼šåˆ†é…æ²»ç–—
            healers.forEach((healer, index) => {
                if (index < Math.ceil(totalPlayers / CONFIG.groupSize)) {
                    teams[index] = [healer];
                } else {
                    const targetTeam = teams.find(t => 
                        t.filter(p => p.role === 'æ²»ç–—').length < CONFIG.minHealersPerTeam
                    ) || teams[index % teams.length];
                    targetTeam.push(healer);
                }
            });

            // ç¬¬äºŒé˜¶æ®µï¼šåˆ†é…DPS
            let dpsIndex = 0;
            teams.forEach(team => {
                while (team.length < CONFIG.groupSize && dpsIndex < dps.length) {
                    team.push(dps[dpsIndex++]);
                }
            });

            // ç¬¬ä¸‰é˜¶æ®µï¼šå¤„ç†å‰©ä½™ç©å®¶
            while (dpsIndex < dps.length) {
                const newTeam = [];
                while (newTeam.length < CONFIG.groupSize && dpsIndex < dps.length) {
                    newTeam.push(dps[dpsIndex++]);
                }
                teams.push(newTeam);
            }

            generateTeamTable(teams, container);

            // ç»Ÿè®¡ä¿¡æ¯
            const stats = teams.reduce((acc, team) => {
                acc.totalTeams++;
                const healersInTeam = team.filter(p => p.role === 'æ²»ç–—').length;
                if (healersInTeam === 0) acc.teamsWithoutHealer++;
                if (healersInTeam > 1) acc.teamsWithExtraHealer++;
                return acc;
            }, { totalTeams: 0, teamsWithoutHealer: 0, teamsWithExtraHealer: 0 });

            if (stats.teamsWithoutHealer > 0) {
                alert(`è­¦å‘Šï¼š${stats.teamsWithoutHealer}ä¸ªé˜Ÿä¼ç¼ºå°‘æ²»ç–—ï¼`);
            }
            if (stats.teamsWithExtraHealer > 0) {
                alert(`æç¤ºï¼š${stats.teamsWithExtraHealer}ä¸ªé˜Ÿä¼æœ‰é¢å¤–æ²»ç–—`);
            }
        }

        // å›¾ç‰‡å¯¼å‡ºåŠŸèƒ½
        async function exportData() {
            const loading = document.getElementById('exportLoading');
            try {
                loading.style.display = 'block';
                
                const cloneContainer = document.getElementById('groupsContainer').cloneNode(true);
                cloneContainer.style.width = '1280px';
                cloneContainer.style.padding = '20px';
                document.body.appendChild(cloneContainer);

                const canvas = await html2canvas(cloneContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#FFFFFF'
                });

                const imgData = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `å¸®æˆ˜ç¼–é˜Ÿ_${currentGuild}_${new Date().toLocaleDateString()}.png`;
                link.href = imgData;
                link.click();

                document.body.removeChild(cloneContainer);
            } catch (error) {
                alert('å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        function generateTeamTable(teams, container) {
            container.innerHTML = '';
            const totalGroups = Math.ceil(teams.length / 5);
            
            for (let g = 0; g < totalGroups; g++) {
                const table = document.createElement('table');
                table.className = 'team-table';

                const header = table.createTHead().insertRow();
                header.innerHTML = `<th colspan="5"><div class="team-header">ç¬¬ ${g+1} å›¢</div></th>`;

                const titleRow = table.insertRow();
                for (let t = 0; t < 5; t++) {
                    const teamIndex = g * 5 + t;
                    titleRow.innerHTML += teamIndex < teams.length ? 
                        `<th>ç¬¬ ${teamIndex + 1} é˜Ÿ (${teams[teamIndex].length}äºº)</th>` : 
                        '<th></th>';
                }

                for (let r = 0; r < CONFIG.groupSize; r++) {
                    const row = table.insertRow();
                    for (let c = 0; c < 5; c++) {
                        const teamIndex = g * 5 + c;
                        const cell = row.insertCell();
                        const team = teams[teamIndex];
                        
                        if (team && team[r]) {
                            const player = team[r];
                            cell.innerHTML = `
                                <div class="team-member" style="color:${getColor(player.className)}">
                                    ${player.name}<br>
                                    <small>${getDisplayName(player.className)}</small>
                                    ${player.role === 'æ²»ç–—' ? '<span class="healer-mark">ğŸŒŸ</span>' : ''}
                                </div>`;
                        } else {
                            cell.innerHTML = '<div class="team-member" style="color:#999">ç©ºç¼º</div>';
                        }
                    }
                }
                container.appendChild(table);
            }
        }

        // ç®¡ç†å‘˜åŠŸèƒ½
        function toggleAdmin() {
            const pwd = document.getElementById('adminPwd').value;
            const isAdminMode = document.body.classList.contains('admin-mode');
            
            if(isAdminMode || pwd === CONFIG.password) {
                document.body.classList.toggle('admin-mode');
                document.getElementById('adminLogin').style.display = 
                    isAdminMode ? 'inline-block' : 'none';
                document.querySelector('.admin-btn').style.display = 
                    isAdminMode ? 'none' : 'inline-block';
                document.getElementById('adminPwd').value = '';
                updateUI();
            } else {
                alert("å¯†ç é”™è¯¯ï¼");
            }
        }

        function removePlayer(index) {
            if(!confirm("ç¡®å®šè¦ç§»é™¤è¯¥ç©å®¶å—ï¼Ÿ")) return;
            const data = guildData[currentGuild];
            const [removed] = data.main.splice(index, 1);
            data.reserve = data.reserve.filter(p => p.name !== removed.name);
            autoFillVacancies();
            updateUI();
            autoGroup();
        }

        function autoFillVacancies() {
            const data = guildData[currentGuild];
            while(data.main.length < CONFIG.maxMain && data.reserve.length > 0) {
                data.main.push(data.reserve.shift());
            }
        }

        function clearData() {
            if(confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰å¸®ä¼šçš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ")) {
                guildData[currentGuild] = { main: [], reserve: [] };
                updateUI();
                autoGroup();
            }
        }

        // è¾…åŠ©åŠŸèƒ½
        function updateUI() {
            const data = guildData[currentGuild];
            const list = document.getElementById('registeredPlayers');
            
            list.innerHTML = data.main.map((player, index) => `
                <div class="player-item" style="color:${getColor(player.className)}">
                    <span>${player.name} - ${getDisplayName(player.className)}</span>
                    <span class="remove-btn" onclick="removePlayer(${index})">Ã— ç§»é™¤</span>
                </div>
            `).join('');
            
            document.getElementById('playerCount').textContent = data.main.length;
            document.getElementById('reserveCount').textContent = data.reserve.length;
        }

        function getDisplayName(className) {
            return className.replace(/é¬¼ç‹$/, 'é¬¼ç‹');
        }

        function getColor(className) {
            const colorMap = {
                'çµæ±': 'var(--healer)',
                'ç…é¬¼ç‹': 'var(--ghost)', 'ç½¡é¬¼ç‹': 'var(--ghost)',
                'é›·é’äº‘': 'var(--cloud)', 'å‰‘é’äº‘': 'var(--cloud)',
                'åˆæ¬¢': 'var(--joy)', 
                'ç‚ç„šé¦™': 'var(--incense)', 'å’’ç„šé¦™': 'var(--incense)'
            };
            return colorMap[className] || '#333';
        }

        function switchGuild(guild) {
            currentGuild = guild;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            updateUI();
            autoGroup();
        }

        // åˆå§‹åŒ–
        document.getElementById('battleDate').textContent = `${getNextFriday()} å¸®æˆ˜`;
        setInterval(() => {
            localStorage.setItem('guildData', JSON.stringify(guildData));
        }, 3000);
        updateUI();
    </script>
</body>
</html>